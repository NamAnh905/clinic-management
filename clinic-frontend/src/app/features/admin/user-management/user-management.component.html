<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="flex flex-column h-full">

    <div class="mb-3 flex-none">
        <h2 class="text-2xl font-bold text-900 m-0">Quản lý người dùng</h2>
    </div>

    <div class="surface-card shadow-1 border-round-xl flex flex-column bg-white overflow-hidden"
         style="height: calc(100vh - 180px);">

        <div class="flex flex-column sm:flex-row justify-content-between align-items-center p-3 border-bottom-1 surface-border flex-none gap-3">

          <div class="flex flex-column sm:flex-row gap-2 w-full sm:w-auto">
              <span class="p-input-icon-left w-full sm:w-auto">
                  <i class="pi pi-search text-500"></i>
                  <input pInputText type="text"
                      [(ngModel)]="keyword"
                      (keyup.enter)="loadUsers()"
                      placeholder="Tìm theo tên, email..."
                      class="w-full sm:w-20rem border-round-2xl pl-5" />
              </span>

              <p-dropdown
                  [options]="filterRoleOptions"
                  [(ngModel)]="selectedRole"
                  (onChange)="loadUsers()"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Vai trò"
                  styleClass="w-full sm:w-11rem border-round-2xl"
                  [showClear]="true">
              </p-dropdown>

              <p-dropdown
                  [options]="statusOptions"
                  [(ngModel)]="selectedStatus"
                  (onChange)="loadUsers()"
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Trạng thái"
                  styleClass="w-full sm:w-12rem border-round-2xl"
                  [showClear]="true">
              </p-dropdown>
          </div>

          <div class="flex flex-column sm:flex-row gap-2 w-full sm:w-auto">

              <button pButton
                      label="Xuất Excel"
                      icon="pi pi-file-excel"
                      class="p-button-success border-round-3xl px-4 w-full sm:w-auto"
                      (click)="exportExcel()">
              </button>

              <button pButton
                      label="Thêm người dùng"
                      icon="pi pi-plus"
                      class="p-button-primary border-round-3xl px-4 w-full sm:w-auto"
                      (click)="openNew()">
              </button>
          </div>

        </div>

        <div class="flex-1 min-h-0 w-full relative">
          <p-table
            [value]="users"
            [lazy]="true"
            (onLazyLoad)="loadUsers($event)"
            [totalRecords]="totalRecords"
            [rows]="size"
            [loading]="loading"
            [rowHover]="true"
            styleClass="p-datatable-sm custom-table h-full"
            [paginator]="true"
            [rowsPerPageOptions]="[5, 10, 15, 20]"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
            paginatorTemplate="PrevPageLink PageLinks NextPageLink CurrentPageReport RowsPerPageDropdown"
        >

              <ng-template pTemplate="header">
                  <tr>
                      <th style="min-width: 3rem"><p-tableHeaderCheckbox></p-tableHeaderCheckbox></th>
                      <th style="min-width: 80px">ID</th>
                      <th style="min-width: 180px">Họ và tên</th>

                      <th style="min-width: 200px">Email</th>
                      <th style="min-width: 120px">Số điện thoại</th>
                      <th style="min-width: 200px">Địa chỉ</th>
                      <th style="min-width: 100px">Vai trò</th>
                      <th style="min-width: 120px">Ngày sinh</th>
                      <th style="min-width: 100px">Giới tính</th>
                      <th style="min-width: 120px">Trạng thái</th>
                      <th class="text-center" style="min-width: 100px">Thao tác</th>
                  </tr>
              </ng-template>

              <ng-template pTemplate="body" let-user>
                  <tr>
                      <td><p-tableCheckbox [value]="user"></p-tableCheckbox></td>

                      <td><span class="text-500 font-medium">#{{ user.userId }}</span></td>

                      <td><span class="font-medium text-900">{{ user.fullName }}</span></td>

                      <td><div class="text-900">{{ user.email }}</div></td>

                      <td><div class="text-500">{{ user.phoneNumber || '---' }}</div></td>
                      <td>
                          <div class="text-500 white-space-nowrap overflow-hidden text-overflow-ellipsis"
                              style="max-width: 250px;"
                              [title]="user.address"> {{ user.address || '---' }}
                          </div>
                      </td>
                      <td>
                          <span [class]="'role-badge role-' + (user.roles[0]?.name || 'patient').toLowerCase()">
                              {{ user.roles[0]?.name || 'PATIENT' }}
                          </span>
                      </td>

                      <td>{{ user.dateOfBirth | date:'dd/MM/yyyy' }}</td>

                      <td>
                          <span [ngClass]="{
                              'text-blue-600': user.gender === 'MALE',
                              'text-pink-500': user.gender === 'FEMALE'
                          }" class="font-medium">
                              {{ user.gender === 'MALE' ? 'Nam' : (user.gender === 'FEMALE' ? 'Nữ' : '---') }}
                          </span>
                      </td>

                      <td>
                          <span [class]="'status-badge ' + (user.isActive ? 'active' : 'locked')">
                              {{ user.isActive ? 'Hoạt động' : 'Vô hiệu' }}
                          </span>
                      </td>

                      <td class="text-center">
                          <button pButton icon="pi pi-pencil" class="p-button-text p-button-info p-button-rounded" (click)="editUser(user)"></button>
                          <button *ngIf="user.isActive" pButton icon="pi pi-trash" class="p-button-text p-button-danger p-button-rounded" (click)="deleteUser(user)" pTooltip="Vô hiệu hóa" tooltipPosition="top"></button>
                          <button *ngIf="!user.isActive" pButton icon="pi pi-lock" class="p-button-text p-button-secondary p-button-rounded" disabled pTooltip="Đã vô hiệu hóa"></button>
                      </td>
                  </tr>
              </ng-template>

              <ng-template pTemplate="emptymessage">
                  <tr>
                      <td colspan="9" class="text-center p-4 text-500">Không tìm thấy dữ liệu.</td>
                  </tr>
              </ng-template>
          </p-table>
        </div>
    </div>
</div>

<p-dialog
    [(visible)]="userDialog"
    [style]="{ width: '550px' }"
    [header]="isEditMode ? 'Cập nhật thông tin' : 'Thêm người dùng mới'"
    [modal]="true"
    styleClass="p-fluid medical-dialog"
    [draggable]="false"
    [resizable]="false">

    <ng-template pTemplate="content">
        <form [formGroup]="userForm" class="mt-3 formgrid grid">

            <div class="field col-12 organic-field">
                <input pInputText id="fullName" formControlName="fullName" placeholder=" " />
                <label class="always-top">Họ và tên <span class="text-red-500">*</span></label>
                <small class="p-error block mt-1" *ngIf="submitted && userForm.get('fullName')?.invalid">Nhập họ tên.</small>
            </div>

            <div class="field col-12 organic-field">
                <input pInputText id="email" formControlName="email" placeholder=" " [readonly]="isEditMode" [class.bg-gray-100]="isEditMode"/>
                <label class="always-top">Email <span class="text-red-500">*</span></label>
            </div>

            <div class="field col-6 organic-field">
                <input pInputText id="phoneNumber" formControlName="phoneNumber" placeholder=" " />
                <label class="always-top">Số điện thoại</label>
            </div>

            <div class="field col-6 organic-field">
                <p-calendar formControlName="dateOfBirth" [showIcon]="true" dateFormat="dd/mm/yy" appendTo="body" placeholder=" "></p-calendar>
                <label class="always-top">Ngày sinh</label>
            </div>

            <div class="field col-6 organic-field">
                <p-dropdown
                    [options]="genderOptions"
                    formControlName="gender"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                    placeholder="Chọn giới tính"
                    [style]="{'width':'100%'}"> </p-dropdown>
                <label class="always-top">Giới tính</label>
            </div>

            <div class="field col-6 organic-field">
                <p-dropdown
                    [options]="formStatusOptions"
                    formControlName="isActive"
                    optionLabel="label"
                    optionValue="value"
                    appendTo="body"
                    placeholder="Chọn trạng thái"
                    [style]="{'width':'100%'}"> </p-dropdown>
                <label class="always-top">Trạng thái</label>
            </div>

            <div class="field col-12 organic-field">
                <input pInputText id="address" formControlName="address" placeholder=" " />
                <label class="always-top">Địa chỉ</label>
            </div>

            <div class="field col-12 organic-field" *ngIf="isEditMode">
                <p-multiSelect [options]="roleOptions" formControlName="roles" optionLabel="label" optionValue="value" appendTo="body" display="chip" placeholder=" "></p-multiSelect>
                <label class="always-top">Vai trò</label>
            </div>

            <div class="field col-12 organic-field">
                <input pInputText type="password" formControlName="password" placeholder=" " />
                <label class="always-top">{{ isEditMode ? 'Mật khẩu mới' : 'Mật khẩu' }}</label>
            </div>

        </form>
    </ng-template>

    <ng-template pTemplate="footer">
        <button pButton label="Hủy" icon="pi pi-times" class="p-button-text" (click)="hideDialog()"></button>
        <button pButton label="Lưu" icon="pi pi-check" class="p-button-primary" (click)="saveUser()"></button>
    </ng-template>
</p-dialog>
