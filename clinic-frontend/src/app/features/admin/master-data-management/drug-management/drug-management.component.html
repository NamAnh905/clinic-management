<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<div class="flex flex-column h-full">

    <div class="mb-3 flex-none">
        <h2 class="text-2xl font-bold text-900 m-0">Quản lý kho thuốc</h2>
    </div>

    <div class="surface-card shadow-1 border-round-xl flex flex-column bg-white overflow-hidden"
         style="height: calc(100vh - 180px);">

        <div class="flex flex-column sm:flex-row justify-content-between align-items-center p-3 border-bottom-1 surface-border flex-none gap-3">

          <div class="flex flex-column sm:flex-row gap-2 w-full sm:w-auto">
              <span class="p-input-icon-left w-full sm:w-auto">
                  <i class="pi pi-search text-500"></i>
                  <input pInputText type="text"
                      [(ngModel)]="keyword"
                      (keyup.enter)="loadDrugs()"
                      placeholder="Tìm tên thuốc..."
                      class="w-full sm:w-20rem border-round-2xl pl-5" />
              </span>
          </div>

          <div class="flex flex-column sm:flex-row gap-2 w-full sm:w-auto">
            <button pButton
                    label="Xuất Excel"
                    icon="pi pi-file-excel"
                    class="p-button-success border-round-3xl px-4 w-full sm:w-auto"
                    (click)="exportExcel()">
            </button>
              <button pButton
                      label="Thêm thuốc mới"
                      icon="pi pi-plus"
                      class="p-button-primary border-round-3xl px-4 w-full sm:w-auto"
                      (click)="openNew()">
              </button>
          </div>

        </div>

        <div class="flex-1 min-h-0 w-full relative">
          <p-table
            [value]="drugs"
            [lazy]="true"
            (onLazyLoad)="loadDrugs($event)"
            [totalRecords]="totalRecords"
            [rows]="size"
            [loading]="loading"
            [rowHover]="true"
            styleClass="p-datatable-sm custom-table h-full"
            [paginator]="true"
            [rowsPerPageOptions]="[10, 20, 50]"
            [showCurrentPageReport]="true"
            currentPageReportTemplate="Hiển thị {first} đến {last} trong tổng số {totalRecords} thuốc"
            paginatorTemplate="PrevPageLink PageLinks NextPageLink CurrentPageReport RowsPerPageDropdown"
        >

              <ng-template pTemplate="header">
                  <tr>
                      <th style="min-width: 50px">ID</th>
                      <th style="min-width: 200px">Tên thuốc</th>
                      <th style="min-width: 70px">Đơn vị</th>
                      <th style="min-width: 90px" class="text-right">Số lượng</th>
                      <th style="min-width: 110px" class="text-right">Đơn giá</th>
                      <th style="min-width: 400px">Hướng dẫn sử dụng</th>
                      <th class="text-center" style="min-width: 110px">Thao tác</th>
                  </tr>
              </ng-template>

              <ng-template pTemplate="body" let-drug>
                  <tr>
                      <td><span class="text-500 font-medium">#{{ drug.drugId }}</span></td>
                      <td><span class="font-medium text-900">{{ drug.name }}</span></td>
                      <td><div class="text-700">{{ drug.unit }}</div></td>
                      <td class="text-right">
                          <span [class.text-red-500]="drug.stockQuantity <= 10" [class.font-bold]="drug.stockQuantity <= 10">
                              {{ drug.stockQuantity }}
                          </span>
                      </td>
                      <td class="text-right">
                          <span class="text-green-600 font-medium">
                              {{ drug.price | currency:'VND':'symbol':'1.0-0' }}
                          </span>
                      </td>
                      <td>
                          <div class="text-500 white-space-nowrap overflow-hidden text-overflow-ellipsis"
                              style="max-width: 100%;"
                              [title]="drug.instructions">
                              {{ drug.instructions || '---' }}
                          </div>
                      </td>

                      <td class="text-center">
                          <button pButton icon="pi pi-pencil" class="p-button-text p-button-info p-button-rounded" (click)="editDrug(drug)" pTooltip="Sửa"></button>
                          <button pButton icon="pi pi-trash" class="p-button-text p-button-danger p-button-rounded" (click)="deleteDrug(drug)" pTooltip="Xóa"></button>
                      </td>
                  </tr>
              </ng-template>

              <ng-template pTemplate="emptymessage">
                  <tr>
                      <td colspan="7" class="text-center p-4 text-500">Không tìm thấy dữ liệu thuốc.</td>
                  </tr>
              </ng-template>
          </p-table>
        </div>
    </div>
</div>

<p-dialog
    [(visible)]="drugDialog"
    [style]="{ width: '550px' }"
    [header]="isEditMode ? 'Cập nhật thông tin thuốc' : 'Thêm thuốc mới'"
    [modal]="true"
    styleClass="p-fluid medical-dialog"
    [draggable]="false"
    [resizable]="false">

    <ng-template pTemplate="content">
        <form [formGroup]="drugForm" class="mt-3 formgrid grid">

            <div class="field col-8 organic-field">
                <input pInputText id="name" formControlName="name" placeholder=" " />
                <label class="always-top">Tên thuốc <span class="text-red-500">*</span></label>
                <small class="p-error block mt-1" *ngIf="submitted && drugForm.get('name')?.invalid">Nhập tên thuốc.</small>
            </div>

            <div class="field col-4 organic-field">
                <input pInputText id="unit" formControlName="unit" placeholder=" " />
                <label class="always-top">Đơn vị (Viên/Vỉ) <span class="text-red-500">*</span></label>
                <small class="p-error block mt-1" *ngIf="submitted && drugForm.get('unit')?.invalid">Nhập đơn vị.</small>
            </div>

            <div class="field col-6 organic-field">
                <p-inputNumber
                    formControlName="stockQuantity"
                    mode="decimal"
                    [min]="0"
                    placeholder=" "
                    inputId="stockQuantity">
                </p-inputNumber>
                <label class="always-top">Số lượng tồn <span class="text-red-500">*</span></label>
            </div>

            <div class="field col-6 organic-field">
                <p-inputNumber
                    formControlName="price"
                    mode="currency"
                    currency="VND"
                    locale="vi-VN"
                    [min]="0"
                    placeholder=" "
                    inputId="price">
                </p-inputNumber>
                <label class="always-top">Đơn giá (VND) <span class="text-red-500">*</span></label>
            </div>

            <div class="field col-12 organic-field">
                <textarea
                    pInputTextarea
                    id="instructions"
                    formControlName="instructions"
                    rows="3"
                    style="resize: none"
                    placeholder=" ">
                </textarea>
                <label class="always-top">Hướng dẫn sử dụng</label>
            </div>

        </form>
    </ng-template>

    <ng-template pTemplate="footer">
        <button pButton label="Hủy" icon="pi pi-times" class="p-button-text" (click)="hideDialog()"></button>
        <button pButton label="Lưu" icon="pi pi-check" class="p-button-primary" (click)="saveDrug()"></button>
    </ng-template>
</p-dialog>
